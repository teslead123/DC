{% extends 'base.html' %}
{% load static %}

{% block title %}- Teslead Dashboard{% endblock %}
{% block page_title %}
< Users 
{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
    .form-container {
        background: #ffffff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        margin: 0 auto;
        transition: all 0.3s ease;
    }
    .section-title {
        font-size: 1.5rem;
        color: #1a1a2e;
        margin-bottom: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 3px solid #3B22C6;
        padding-bottom: 8px;
    }
    .section-icon {
        font-size: 1.2rem;
        color: #fff;
        background: linear-gradient(135deg, #3B22C6, #4C8CF1);
        padding: 6px;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        background: #fff;
    }
    .items-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
        color: #333;
        border: 1px solid #d3d9e6;
    }
    .items-table thead th {
        background: linear-gradient(135deg, #3B22C6, #4C8CF1);
        color: #ffffff;
        padding: 12px 15px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        border: 1px solid #d3d9e6;
    }
    .items-table tbody tr:nth-child(odd) {
        background-color: #ffffff !important;
    }
    .items-table tbody tr:nth-child(even) {
        background-color: rgb(178, 192, 231) !important;
    }
    .items-table tbody tr:hover {
        background-color: #e6f0ff !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    .items-table td, .items-table th {
        padding: 12px 15px;
        vertical-align: middle;
        border: 1px solid #d3d9e6;
    }
    .items-table td.text-center {
        font-style: italic;
        color: #6c757d;
    }
    .btn-sm {
        padding: 8px 15px;
        font-size: 0.85rem;
        font-weight: 500;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #3B22C6, #4C8CF1);
        border: none;
        color: #fff;
    }
    .btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 34, 198, 0.3);
        background: linear-gradient(135deg, #4C8CF1, #3B22C6);
    }
    .create-btn {
        background: linear-gradient(135deg, #28a745, #38c172);
    }
    .create-btn:hover {
        background: linear-gradient(135deg, #38c172, #28a745);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    .delete-btn {
        background: linear-gradient(135deg, #ff4757, #ff6b81);
    }
    .delete-btn:hover {
        background: linear-gradient(135deg, #ff6b81, #ff4757);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
    }
    .back-btn-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .modal-header {
        background: linear-gradient(135deg, #3B22C6, #4C8CF1);
        color: #ffffff;
        border-radius: 12px 12px 0 0;
        padding: 15px 20px;
    }
    .modal-title {
        font-weight: 600;
        font-size: 1.2rem;
    }
    .modal-body {
        padding: 20px;
        background: #ffffff;
    }
    .form-control {
        border-radius: 6px;
        font-size: 0.9rem;
        padding: 10px;
        border: 1px solid #d3d9e6;
    }
    .form-control:focus {
        border-color: #3B22C6;
        box-shadow: 0 0 5px rgba(59, 34, 198, 0.3);
    }
    .form-label {
        font-weight: 500;
        font-size: 0.9rem;
        color: #1a1a2e;
        margin-bottom: 5px;
    }

    /* Remove number spinners – Chrome/Safari/Edge (WebKit) */
.form-control::-webkit-outer-spin-button,
.form-control::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Remove number spinners – Firefox */
.form-control{
  -moz-appearance: textfield;
  appearance: textfield; /* modern fallback */
}


    @media (max-width: 768px) {
        .form-container {
            padding: 15px;
        }
        .items-table {
            font-size: 0.85rem;
        }
        .items-table th,
        .items-table td {
            padding: 10px;
        }
        .btn-sm {
            width: 100%;
            justify-content: center;
        }
        .table-responsive {
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}

    <div class="form-container">
        <!-- <h2 class="section-title">
            <i class="fas fa-users section-icon"></i> Users List
        </h2> -->
        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-sm create-btn" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="fas fa-user-plus"></i> Create User
            </button>
        </div>
        <div class="table-responsive">
            <table class="table items-table" id="userTable">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Employee Id</th>
                        <th>Username</th>
                        <th>Email ID</th>
                        <th>Role</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}" data-phone="{{ user.phone }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ user.employee_id }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.role }}</td>
                        <td>
                            <button class="btn btn-sm" onclick="editUser('{{ user.id }}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm delete-btn" onclick="deleteUser('{{ user.username }}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No users found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="back-btn-container">
            <button class="btn btn-sm" onclick="window.history.back()" title="Back">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
    </div>
</div>
<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                      <div class="mb-3">
                        <label for="employee_id" class="form-label">Employee ID</label>
                        <input type="text" class="form-control" id="employee_id" name="employee_id" required>
                    </div>

                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email ID</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-control" id="role" name="role" required>
                            <option value="User">User</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-sm delete-btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="edit-user-id" name="id">
                     <div class="mb-3">
                        <label for="edit-employee_id" class="form-label">Employee ID</label>
                        <input type="text" class="form-control" id="edit-employee_id" name="employee_id" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="edit-username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-email" class="form-label">Email ID</label>
                        <input type="email" class="form-control" id="edit-email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-phone" class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="edit-phone" name="phone" >
                    </div>
                    <div class="mb-3">
                        <label for="edit-role" class="form-label">Role</label>
                        <select class="form-control" id="edit-role" name="role" required>
                            <option value="User">User</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-sm delete-btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- SweetAlert2 CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.1/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.1/sweetalert2.min.css">
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function editUser(userId) {
    // const row = [...document.querySelectorAll('tr[data-user-id]')].find(r => r.children[1].textContent.trim() === username);
    // if (!row) return;
    const row = document.querySelector(`tr[data-user-id='${userId}']`);
    if (!row) return;


//    const userId = row.dataset.userId;
//     const usernameVal = row.children[1].textContent.trim();
//     const employee_id = row.children[2].textContent.trim();
//     const email = row.children[3].textContent.trim();
//     const role = row.children[4].textContent.trim();
//     const phone = row.children[5].textContent.trim();

   // Populate modal fields
    document.getElementById('edit-user-id').value = row.dataset.userId;
    document.getElementById('edit-username').value = row.dataset.username || '';
    document.getElementById('edit-employee_id').value = row.dataset.employee_id || '';
    document.getElementById('edit-email').value = row.dataset.email || '';
    document.getElementById('edit-role').value = row.dataset.role || '';
    document.getElementById('edit-phone').value = row.dataset.phone || '';
    
    // Show the edit modal
    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    editModal.show();
}

function deleteUser(username) {
    Swal.fire({
        title: 'Are you sure?',
        text: `You are about to delete user: ${username}.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/api/delete_user/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: username })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire({
                        title: 'Deleted!',
                        text: 'User has been deleted.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error', 'Something went wrong: ' + error.message, 'error');
            });
        }
    });
}

document.getElementById('createUserForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {
        username: formData.get('username'),
        employee_id:formData.get('employee_id'),
        email: formData.get('email'),
        password: formData.get('password'),
        role: formData.get('role'),
        phone: formData.get('phone')
    };

    // Client-side validation
    if (!data.employee_id || !data.username || !data.email || !data.password || !data.role) {
        Swal.fire('Error', 'All fields are required.', 'error');
        return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
        Swal.fire('Error', 'Invalid email format.', 'error');
        return;
    }
    if (data.password.length < 6) {
        Swal.fire('Error', 'Password must be at least 6 characters long.', 'error');
        return;
    }

    fetch('/api/create_user/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            Swal.fire({
                title: 'Created!',
                text: 'User has been created successfully.',
                icon: 'success',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                window.location.reload();
            });
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error', 'Something went wrong: ' + error.message, 'error');
    });
});

// Edit User Form Handler
document.getElementById('editUserForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {
        id: formData.get('id'),
        employee_id:formData.get('employee_id'),
        username: formData.get('username'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        role: formData.get('role')
    };

    // Client-side validation
    if (!data.username || !data.email || !data.role) {
        Swal.fire('Error', 'All fields are required.', 'error');
        return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
        Swal.fire('Error', 'Invalid email format.', 'error');
        return;
    }

    fetch('/api/edit_user/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            Swal.fire({
                title: 'Updated!',
                text: 'User has been updated successfully.',
                icon: 'success',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                window.location.reload();
            });
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error', 'Something went wrong: ' + error.message, 'error');
    });
});
</script>
{% endblock %}