{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teslead Connect - Login</title>
      <link rel="icon" type="image/png" href="{% static 'images/Teslead-Connect-Logo.png' %}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/loginpage.css' %}">
</head>
<body>
    {% csrf_token %}
    <div class="container-fluid main-container">
        <div class="row min-vh-100">
            <!-- Username Section -->
            <div id="username-container" class="row min-vh-100">
                <!-- Left Section -->
                <div class="col-md-6 left-section">
                    <img src="{% static 'images/Teslead-Connect-Logo.png' %}" alt="Teslead SmartSync X" class="img-fluid">
                </div>
                
                <!-- Right Section -->
                <div class="col-md-6 right-section">
                    <img src="{% static 'images/Teslead-Logo-White.png' %}" alt="Teslead Logo" class="brand-logo">
                    
                    <div class="login-card">
                        <div class="polygon-header"></div>
                        <div class="text-start mb-4">
                            <img src="{% static 'images/Teslead-Logo.png' %}" alt="Teslead Logo" class="small-logo">
                        </div>
                        <h1 class="text-start">SIGN IN</h1>
                        <h3 class="text-start">Use your account to login</h3>
                        
                        <div>
                            <input type="text" class="form-control" id="employee_id" placeholder="Enter ID">
                            <!-- <p class="blue-text" onclick="forgot_username()">Forget Username?</p> -->
                            <div id="errormsg" class="error-msg"></div>
                         
                        </div>
                        
                        
                        <div class="d-flex align-items-center mb-4">
                            <!-- <p class="blue-text mb-0" id="create_ac">Create Account</p> -->
                            <button class="action-btn" onclick="new_usercheck()">Next</button>
                        </div>
                        
                        <div class="footer-text">
                            <p class="blue-text">Powered By</p>
                            <p class="text-white">Teslead Equipments Private Limited</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Password Section -->
            <div id="password-container" class="row min-vh-100 hidden">
                <!-- Left Section -->
                <div class="col-md-6 left-section">
                    <img src="{% static 'images/Teslead-Connect-Logo.png' %}" alt="Teslead SmartSync X" class="img-fluid">
                </div>
                
                <!-- Right Section -->
                <div class="col-md-6 right-section">
                    <img src="{% static 'images/Teslead-Logo-White.png' %}" alt="Teslead Logo" class="brand-logo">
                    
                    <div class="login-card">
                        <div class="polygon-header"></div>
                        <div class="text-start mb-4">
                            <img src="{% static 'images/Teslead-Logo.png' %}" alt="Teslead Logo" class="small-logo">
                        </div>
                        <h1 class="text-start" id="pwdname">SIGN IN</h1>
                       <h3 class="text-start">Use your account to login</h3>

                        <div class="mb-3 mt-5">
                            <input type="password" class="form-control" id="password_field" placeholder="Enter Password">
                            <input type="checkbox" class="form-check-input" id="checkbox1">
                            <label class="form-check-label text-white" for="checkbox1" id="showpassword">Show Password</label>
                            <div id="errormsg1" class="error-msg"></div>
                        </div>
                        
                        
                        <div class="dalign-items-center mb-4">
                           
                            <!-- <p class="blue-text mb-0" id="create_ac">Create Account</p> -->
                            <button class="action-btn" id="nextbtn" onclick="new_passwordcheck()">Next</button>
                        </div>
                        <button class="bluee-text" onclick="backbtn()">Back</button>
                        <div class="footer-text1">
                            <p class="blue-text">Powered By</p>
                            <p class="text-white">Teslead Equipments Private Limited</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Welcome Section -->
            <div id="welcome-container" class="row min-vh-100 hidden">
                <!-- Left Section -->
                <div class="col-md-6 left-section">
                    <img src="{% static 'images/Teslead-Connect-Logo.png' %}" alt="Teslead SmartSync X" class="img-fluid">
                </div>
                
                <!-- Right Section -->
                <div class="col-md-6 right-section d-flex align-items-center">
                    <img src="{% static 'images/Teslead-Logo-White.png' %}" alt="Teslead Logo" class="brand-logo">
                    
                    <div class="welcome-card">
                        <div class="polygoon-header"></div>
                        <div class="text-start mb-3">    
                        </div>
                        <h1 id="welcomename">WELCOME</h1>
                        <h3>WELCOME BACK!</h3>
                        <p class="text-white">LOADING.....</p>
                        
                        <div class="footer-text2">
                            <p class="blue-text2">Powered By</p>
                            <p class="text-white">Teslead Equipments Private Limited</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Forgot Username Section -->
            <div id="forgot-username-container" class="row min-vh-100 hidden">
                <!-- Left Section -->
                <div class="col-md-6 left-section">
                    <img src="{% static 'images/tssx-image-1.png' %}" alt="Teslead SmartSync X" class="img-fluid">
                </div>
                
                <!-- Right Section -->
                <div class="col-md-6 right-section">
                    <img src="{% static 'images/Teslead-Logo-White.png' %}" alt="Teslead Logo" class="brand-logo">
                    
                    <div class="login-card">
                        <div class="polygon-header"></div>
                        <div class="text-start mb-4">
                            <img src="{% static 'images/Teslead-Logo.png' %}" alt="Teslead Logo" class="small-logo">
                        </div>
                        <h1 class="text-start">SIGN IN</h1>
                        <h3 class="text-start">Find Your Username</h3>
                        
                        <!-- <div class="mb-3">
                            <input type="text" class="form-control" id="employee_id" placeholder="Enter Your Employee id here..">
                        </div> -->
                        
                        <div class="mb-3">
                            <input type="text" class="form-control" id="recovered_username" placeholder="Get Your username here.." readonly>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <button class="action-btn" onclick="backToLogin()">Back</button>
                            <button class="action-btn" onclick="recoverUsername()">Next</button>
                        </div>
                        
                        <div class="footer-text">
                            <p class="blue-text">Powered By</p>
                            <p class="text-white">Teslead Equipments Private Limited</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- From Uiverse.io by BlackisPlay --> 
<div id="triangle" class="hidden">
  <svg id="Layer_1" data-name="Layer 1" version="1.1" viewBox="0 0 2000 2000">
    <polygon
      class="cls-1"
      points="928 781 1021 951 784.5 1371.97 1618 1371.97 1530.32 1544 509 1539 928 781"
    ></polygon>
    <polygon
      class="cls-3"
      points="1618 1371.97 784.5 1371.97 874.93 1211 1346 1211 923.1 456 1110.06 456 1618 1371.97"
    ></polygon>
    <g id="Layer_2" data-name="Layer 2">
      <polygon
        class="cls-2"
        points="418 1372.74 509 1539 928 781 1162.32 1211 1346 1211 923.1 456 418 1372.74"
      ></polygon>
    </g>
  </svg>
</div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% comment %} <script src="{% static 'js/login.js' %}"></script> {% endcomment %}
    <!-- Custom JavaScript -->
   <script>
     var username2 = ""

// Get CSRF token function
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function new_usercheck() {
    var employee_id1 = document.getElementById("employee_id");
    var employee_id = employee_id1.value.trim();  
    var errormsg = document.getElementById("errormsg");
    var username_container = document.getElementById("username-container");
    var password_container = document.getElementById("password-container");
    username2 = employee_id

    if (employee_id === "") {
        errormsg.style.display = "block";
        errormsg.innerHTML = "Enter Employee Id";
        employee_id1.style.border = "1px solid red";
        return;
    } else {
        var formdata = new FormData();
        formdata.append('employee_id', employee_id);
        formdata.append('csrfmiddlewaretoken', getCSRFToken());

        fetch('/new_username/', {
            method: 'POST',
            body: formdata,
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(data.status);
            if (data.status == "success") {
                var employeeId = data.employee_id;   // TL31
                var userName   = data.username;
                errormsg.innerHTML = ""; 
                username_container.classList.add("hidden");
                password_container.classList.remove("hidden");
                document.getElementById("pwdname").innerHTML = "Hi " + userName.toUpperCase();
                // Focus on password field after successful username validation
                document.getElementById("password_field").focus();
            } else {
                errormsg.innerHTML = data.message;
                errormsg.style.display = "block";
                errormsg.style.color = "red";
                employee_id1.style.border = "1px solid red";
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errormsg.innerHTML = "An error occurred. Please try again later.";
            errormsg.style.display = "block";
            errormsg.style.color = "red";
            employee_id1.style.border = "1px solid red";
        });
    }
}

// Back button functionality
function backbtn() {
    location.reload();
}

function new_passwordcheck() {
    var password_field1 = document.getElementById('password_field');        
    var password_field = password_field1.value.trim();
    var errormsg1 = document.getElementById('errormsg1');
    var password_container = document.getElementById("password-container");
    var welcome_container = document.getElementById("welcome-container");

    if (password_field === "") {
        errormsg1.innerHTML = "Enter Password";
        errormsg1.style.display = "block";
        errormsg1.style.color = "red";
        password_field1.style.border = "1px solid red";
        return;
    }

    errormsg1.style.color = "gray";
    errormsg1.innerHTML = "Validating...";
    errormsg1.style.display = "block";

    var formdata = new FormData();
    formdata.append('password', password_field);
    formdata.append('employee_id', username2);
    formdata.append('csrfmiddlewaretoken', getCSRFToken());

    fetch('/new_pwd/', {
        method: "POST",
        body: formdata
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === "success") {
            var userName   = data.username;
            try {
                // store real role & employee_id
                localStorage.setItem("role", data.role || "user");
                localStorage.setItem('employee_id', data.employee_id);
                localStorage.setItem('username', data.username || "");
            } catch (e) {
                console.log("localStorage not available");
            }

            errormsg1.innerHTML = "";
            password_field1.style.border = "1px solid green";
            password_container.classList.add("hidden");
            welcome_container.classList.remove("hidden");
            document.getElementById("welcomename").textContent = "Hi " + userName.toUpperCase();

            setTimeout(() => {
                window.location.href = `/dashboard/`;
            }, 2000);
        } else {
            errormsg1.innerHTML = data.message;
            errormsg1.style.display = "block";
            errormsg1.style.color = "red";
            password_field1.style.border = "1px solid red";
        }
    })
    .catch(error => {
        console.error('Error:', error);
        errormsg1.innerHTML = "An error occurred. Please try again later.";
        errormsg1.style.display = "block";
        errormsg1.style.color = "red";
    });
}


// Show password functionality
var checkbox1 = document.getElementById("checkbox1");
var password_field = document.getElementById("password_field");
var showpassword = document.getElementById("showpassword");

if (checkbox1 && password_field && showpassword) {
    checkbox1.addEventListener('change', function() {
        if (checkbox1.checked) {
            password_field.type = "text";
            showpassword.innerHTML = "Hide Password";
        } else {
            password_field.type = "password";
            showpassword.innerHTML = "Show Password";
        }
    });
}

// Special character filtering for username
const usernameInputField = document.getElementById('username');
if (usernameInputField) {
    usernameInputField.addEventListener('input', function () {
        const cleaned = this.value.replace(/[^a-zA-Z0-9-_]/g, '');
        if (this.value !== cleaned) {
            this.value = cleaned;
        }
    });
}

// Enter key event listeners - moved to end of file to ensure DOM is ready
// Username field Enter key event
setTimeout(function() {
    const usernameField = document.getElementById('username');
    if (usernameField) {
        usernameField.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                new_usercheck();
            }
        });
    }

    // Password field Enter key event
    const passwordField = document.getElementById('password_field');
    if (passwordField) {
        passwordField.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                new_passwordcheck();
            }
        });
    }

    // Employee ID field Enter key event for username recovery
    const employeeIdField = document.getElementById('employee_id');
    if (employeeIdField) {
        employeeIdField.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                recoverUsername();
            }
        });
    }
}, 100);

// Username recovery function
// function recoverUsername() {
//     const employeeId = document.getElementById('employee_id').value;
//     const recoveredUsernameField = document.getElementById('recovered_username');
    
//     if (!employeeId.trim()) {
//         alert('Please enter your Employee ID');
//         return;
//     }
    
//     var formdata = new FormData();
//     formdata.append('employee_id', employeeId);
//     formdata.append('csrfmiddlewaretoken', getCSRFToken());
    
//     fetch('/recover_username/', {
//         method: 'POST',
//         body: formdata,
//         headers: {
//             'X-CSRFToken': getCSRFToken()
//         }
//     })
//     .then(response => {
//         if (!response.ok) {
//             throw new Error(`HTTP error! status: ${response.status}`);
//         }
//         return response.json();
//     })
//     .then(data => {
//         if (data.status === 'success') {
//             recoveredUsernameField.value = data.username;
//         } else {
//             alert(data.message);
//         }
//     })
//     .catch(error => {
//         console.error('Error:', error);
//         alert('An error occurred. Please try again later.');
//     });
// }

// Back to login function
function backToLogin() {
    location.reload();
}
    </script>
</body>
</html>