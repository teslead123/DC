{% extends 'base.html' %}
{% load static %}

{% block page_title %}< View Open Delivery Challan{% endblock %}

 

{% block content %}
<div class="bg-white  overflow-hidden  p-6">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    
  <!-- Left: DC Details -->
<div class="mb-3">
  <label class="form-label">DC Number</label>
  <div class="d-flex align-items-center mb-3" style="max-width: 350px;">
    <span class="form-control "  style="font-size: 1.4rem;  font-weight:bold; border: none; padding:0; letter-spacing: 0.5px;">
      {{ dc.dcNo|default:"Not Assigned" }}
    </span>
    <!-- Status badge -->
 
     <span class="badge" style="color: white; background-color: black;">Open</span>

  
  </div>

  <!-- Action Buttons -->
  <div class="d-flex flex-wrap align-items-center gap-2 mt-3" style="font-size: 13px;" >
   
    </button> 
     <button type="button" class="btn btn-cancel">
      Cancel DC
    </button>

    
    <button type="button" class="btn btn-danger"
        onclick="dcDelete('{{ dc.draft_id }}')">
      Delete DC
    </button>

    
    <button type="button" id="updateButton" class="btn btn-update">
        Update DC
    </button>

  <a href="#" class="text-dark fw-bold">Generate Report</a>
  <a href="#" class="text-danger fw-bold">Generate DC</a>

   
  </div>
</div>



    <!-- Right: Supplier Details -->
    <div class="bg-white">
        <div class="d-flex align-items-center justify-content-end mb-2 gap-2">
            <i class="fas fa-user text-secondary"></i>
            <h2 class="h5 fw-semibold mb-0 text-end" style="font-size: 12px; color: red;">Supplier Details</h2>
        </div>

        <div class="d-flex flex-column text-end small">
            <span class="text-dark" style="font-size:24px; font-weight: bold;">{{ dc.buyerName|default:"-" }}</span>
            <span class="text-dark">{{ dc.buyerGstin|default:"-" }}</span>
            <span class="text-dark">{{ dc.buyerAddress1|default:"-" }}, {{ dc.buyerAddress2|default:"-" }}</span>
            <span class="text-dark">{{ dc.buyerCity|default:"-" }}, {{ dc.buyerState|default:"-" }}</span>
            <span class="text-dark">{{ dc.buyerPincode|default:"-" }}</span>
        </div>
    </div>

  </div>
<div class="row mt-4 g-4">
  <!-- DC Type -->
  <div class="col-12 col-md-3">
    <div class="bg-light border-start border-start-4 border-primary px-3 py-3 d-flex justify-content-between align-items-center shadow-sm" style="height:40px;">
      <span class="small text-dark" style="font-size:12px; font-weight: bold;">DC Type</span>
      <span class="fw-semibold text-dark small">
        {{ dc.dcType }}
      </span>
    </div>
  </div>

  <!-- Repeat for other 3 boxes -->
  <div class="col-12 col-md-3">
    <div class="bg-light border-start border-start-4 border-success px-3 py-3 d-flex justify-content-between align-items-center shadow-sm" style="height:40px;">
      <span class="small text-dark">DC Date</span>
      <span class="fw-semibold text-dark small">{{ dc.dcDate }}</span>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="bg-light border-start border-start-4 border-danger px-3 py-3 d-flex justify-content-between align-items-center shadow-sm" style="height: 40px;">
      <span class="small text-dark">Process</span>
      <span class="fw-semibold text-dark small">{{ dc.process }}</span>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="bg-light border-start border-start-4 border-info px-3 py-3 d-flex justify-content-between align-items-center shadow-sm" style="height: 40px;">
      <span class="small text-dark">Vehicle No</span>
      <span class="fw-semibold text-dark small">{{ dc.vehicleNo }}</span>
    </div>
  </div>
</div>



<!-- Item Details Section -->
<div class="mt-4 bg-light border-start border-start-4 border-pink p-2">
  
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3 ps-2">
    <h2 class="h5 fw-semibold text-secondary mb-0">Item Details</h2>
    <a href="#" onclick="openAllItemsModal()" class="small text-primary fw-medium text-decoration-underline">
      View All Items
    </a>
  </div>

  <!-- Table -->
  <div class="table-responsive">
  <table class="table table-bordered table-hover shadow-sm align-middle text-center  custom-table">
    <thead class="table-light">
      <tr>
        <th scope="col">S No</th>
        <th scope="col">Item Name</th>
        <th scope="col">Quantity</th>
        <th scope="col">UOM</th>
        <th scope="col">Project Name</th>
        <th scope="col">Project Incharge</th>
        <th scope="col">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for item in dc.items %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ item.item_name }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.uom }}</td>
        <td>{{ item.project_name }}</td>
        <td>{{ item.project_incharge }}</td>
        <td>
          <button onclick="openDetails('{{ item.id }}')" class="btn btn-link text-primary p-0">
            Details
          </button>
        </td>
      </tr>
      {% endfor %}

      <!-- Notes row -->
      <tr>
        <td colspan="7" class="text-start">
          <div>
            <label class="form-label small text-muted">Notes</label>
            <div class="form-control bg-light">
              {{ dc.dc_notes|default:"-" }}
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>



  <!--Item Modal -->
  <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-[450px]">
      <h3 class="text-lg font-semibold mb-4">Item Details</h3>
      <div id="detailsContent" class="space-y-2 text-gray-700"></div>
      <div class="mt-6 text-right">
        <button onclick="closeDetails()" 
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Modal for All Items -->
  <div id="allItemsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 
    flex items-center justify-end  z-50" >
    <div class="bg-white rounded-lg shadow-lg p-4 w-[75%] max-w-6xl">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">All Item Details</h3>
        <button onclick="closeAllItemsModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      </div>
      
      <!-- Table -->
      <div class="overflow-x-auto max-h-[70vh] overflow-y-auto">
        <table class="w-full border-collapse shadow-sm">
          <thead>
            <tr class="text-gray-700 text-sm border-t-2 border-red-500">
              <th class="px-2 text-center border-l-2 border-r-2 border-b-2">S No</th>
              <th class="px-2  text-center border-r-2 border-b-2">Item Name</th>
              <th class="px-2  text-center border-r-2 border-b-2">Description</th>
              <th class="px-2  text-center border-r-2 border-b-2">UOM</th>
              <th class="px-2  text-center border-r-2 border-b-2">Quantity</th>
              <th class="px-2  text-center border-r-2 border-b-2">Weight/Unit</th>
              <th class="px-2 text-center border-r-2 border-b-2">Total Weight</th>
              <th class="px-2  text-center border-r-2 border-b-2">SquareFeet/Unit</th>
              <th class="px-2  text-center border-r-2 border-b-2">Total Square Feet</th>
              <th class="px-2  text-center border-r-2 border-b-2">Rate</th>
              <th class="px-2 text-center border-r-2 border-b-2">Project Name</th>
              <th class="px-2  text-center border-r-2 border-b-2">Project Incharge</th>
              <th class="px-2  text-center border-r-2 border-b-2">Remarks</th>
            </tr>
          </thead>
          <tbody class="text-sm text-gray-700">
            {% for item in dc.items %}
            <tr>
              <td class="px-4 py-2 border-l-2  border-r-2 border-b-2">{{ forloop.counter }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.item_name }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.description }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.uom }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.quantity }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.weight_per_unit}}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.weight }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.square_feet_per_unit}}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.square_feet }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.rate_per_each }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.project_name }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.project_incharge }}</td>
              <td class="px-4 py-2 border-r-2 border-b-2">{{ item.remarks }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Update Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">Update Delivery Challan - {{ dc.dcNo }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateDeliveryNoteForm">
                        {% csrf_token %}
                        <!-- Items Details Section -->
                        <div class="form-section items-section">
                            <h2 class="section-title">
                                <i class="fas fa-box section-icon"></i> Items Details
                            </h2>
                            <div class="table-responsive">
                                <table class="table items-table" id="modalItemsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 5%;">S.No</th>
                                            <th style="width: 20%;">Item Name</th>
                                            <th style="width: 25%;">Description</th>
                                            <th style="width: 10%;">UOM</th>
                                            <th style="width: 10%;">Original Quantity</th>
                                            <th style="width: 8%;">Weight</th>
                                            <th style="width: 8%;">Square_feet</th>
                                            <th style="width: 10%;">Rate</th>
                                            <th style="width: 10%;">Project Name</th>
                                            <th style="width: 15%;">Project Incharge</th>
                                            <th style="width: 15%;">Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modalItemsTableBody">
                                        {% for item in dc.items %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td><input type="text" class="form-control" value="{{ item.item_name }}" readonly></td>
                                            <td><input type="text" class="form-control" value="{{ item.description }}" readonly></td>
                                            <td><input type="text" class="form-control" value="{{ item.uom }}" readonly></td>
                                            <td><input type="number" class="form-control original-quantity" value="{{ item.quantity }}" readonly></td>
                                            <td><input type="number" class="form-control" value="{{ item.weight }}" readonly></td>
                                            <td><input type="number" class="form-control" value="{{ item.square_feet }}" readonly></td>
                                            <td><input type="number" class="form-control" value="{{ item.rate }}" readonly></td>
                                            <td><input type="text" class="form-control" value="{{ item.project_name }}" readonly></td>
                                            <td><input type="text" class="form-control" value="{{ item.mtr_dha }}" readonly></td>
                                            <td><input type="text" class="form-control" value="{{ item.remarks }}" readonly></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Received Party Details Section -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-user section-icon"></i> Received Party Details
                            </h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="partyName">Party Name <span class="required">*</span></label>
                                    <input type="text" class="form-control party-autocomplete" id="partyName" name="partyName" value="{{ dc.buyerName|default:'' }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="partyAddress1">Address Line 1 <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="partyAddress1" name="partyAddress1" value="{{ dc.buyerAddress1|default:'' }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="partyAddress2">Address Line 2</label>
                                    <input type="text" class="form-control" id="partyAddress2" name="partyAddress2" value="{{ dc.buyerAddress2|default:'' }}">
                                </div>
                                <div class="form-group">
                                    <label for="partyState">State <span class="required">*</span></label>
                                    <select class="form-control" id="partyState" name="partyState" required>
                                        <option value="">Select State</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="partyCity">City <span class="required">*</span></label>
                                    <select class="form-control" id="partyCity" name="partyCity" required>
                                        <option value="">Select City</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="partyPincode">Pincode <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="partyPincode" name="partyPincode" value="{{ dc.buyerPincode|default:'' }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="partyGstin">GSTIN</label>
                                    <input type="text" class="form-control" id="partyGstin" name="partyGstin" value="{{ dc.buyerGstin|default:'' }}">
                                </div>
                                <div class="form-group">
                                    <label for="partyStateCode">State Code <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="partyStateCode" name="partyStateCode" value="{{ dc.buyerStateCode|default:'' }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="modalDcNo">DC Number <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="modalDcNo" name="dcNo" value="{{ dc.dcNo|default:'' }}" readonly required>
                                </div>
                                <div class="form-group">
                                    <label for="partyDcNumber">Party DC Number <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="partyDcNumber" name="partyDcNumber" required placeholder="Party DC Number">
                                </div>
                                <div class="form-group">
                                    <label for="partyDcDate">Party DC Date <span class="required">*</span></label>
                                    <input type="date" class="form-control" id="partyDcDate" name="partyDcDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="partyDcDocName">Party DC Doc Name</label>
                                    <input type="text" class="form-control" id="partyDcDocName" name="partyDcDocName" placeholder="Document Name">
                                </div>
                            </div>
                        </div>

                        <!-- Received Item Details Section -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-truck-loading section-icon"></i> Received Item Details
                            </h2>
                            <div class="table-responsive">
                                <table class="table items-table" id="receivedItemsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 5%;">S.No</th>
                                            <th style="width: 20%;">Item Name</th>
                                            <th style="width: 20%;">Description</th>
                                            <th style="width: 10%;">UOM</th>
                                            <th style="width: 10%;">Original Quantity</th>
                                            <th style="width: 10%;">Received Quantity </th>
                                            <th style="width: 10%;">Defect Quantity</th>
                                            <th style="width: 10%;">Received Weight</th>
                                            <th style="width: 15%;">Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="receivedItemsTableBody">
                                        {% for item in dc.items %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td><input type="text" class="form-control" value="{{ item.item_name }}" readonly></td>
                                            <td><input type="text" class="form-control" value="{{ item.description }}" readonly></td>
                                            <td><input type="text" class="form-control" value="{{ item.uom }}" readonly></td>
                                            <td><input type="number" class="form-control original-quantity" value="{{ item.quantity }}" readonly></td>
                                            <td><input type="number" class="form-control received-quantity" name="received_quantity[]" step="0.01" placeholder="Enter quantity"></td>
                                            <td><input type="number" class="form-control defect-quantity" name="defect_quantity[]" step="0.01" placeholder="Enter defect qty" value="0"></td>
                                            <td><input type="number" class="form-control received-weight" name="received_weight[]" step="0.01" placeholder="Enter weight (optional)"></td>
                                            <td><input type="text" class="form-control" name="received_remarks[]" placeholder="Remarks"></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="closeDcBtn" disabled>Close DC</button>
                    <button type="button" class="btn btn-warning" id="partialDcBtn" disabled>Partial DC</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}




{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
<link href="{% static 'css/draft.css' %}"  rel="stylesheet">


 <style>
 .badge {
  display: inline-block;
  padding: 6px 27px;
  font-size: 0.75em;
  font-weight: 700;
  line-height: 1;
  text-align: center;
  white-space: nowrap;
  vertical-align: baseline;
  border-radius: 0.25rem;
}

.btn-cancel {
  height: 30px;
  font-size: 12px;
  font-weight: bold;
  text-align: center;
  color: #fff;
  background-color: #e9a719df; /* Bootstrap danger red */
  border: none;
  border-radius: 4px;
}

.btn-cancel:hover {
  background-color: #ecb337df; /* darker red on hover */
}

.btn-update {
  height: 30px;
  font-size: 12px;
  font-weight: bold;
  text-align: center;
  color: #fff;
  background-color: #0018f0df; /* Bootstrap danger red */
  border: none;
  border-radius: 4px;
}

.btn-update:hover {
  background-color:  #0018f0c0; /* darker red on hover */
}

.btn-danger{
    height: 30px;
    font-size: 12px;
  font-weight: bold;
  text-align: center;
  color: #fff;
  background-color: red; 
  border: none;
  border-radius: 4px;

}

.btn-danger:hover {
    background-color: rgba(255, 0, 0, 0.703);
}


.custom-gap {
  margin-right: 4px; /* Bootstrap me-2 = 0.5rem â‰ˆ 8px */
}

.border-start-4 {
  border-left-width: 5px !important;  /* thickness only */
}

.border-pink {
  border-color: #ec4899 !important; /* Tailwind's pink-500 */
}


.custom-table {
    /* border-top: 2px solid red;   Only top border in red */
    border-collapse: separate; 
    border-spacing: 5px;  /* Remove gaps between cells */
    width: 100%;
  }

  /* Header row background */
  .custom-table thead tr {
    background-color: #8d8f91;   /* Light gray like Bootstrap */
  }

  /* Header cells */
  .custom-table th {
    /* border-top: 2px solid red; */
    border: none;
    padding: 8px;
    text-align: left;
    font-weight: 500;
    font-size: 15px;
    color: #474848;
    
  }

  /* Body cells */
  .custom-table td {
     border-top: 2px solid red;
    padding: 8px;
    text-align: center;
     font-size: 14px;
     background-color: #b5b7ba;   
  }

  /* Optional: spacing between rows */
  .custom-table tbody tr + tr {
    border-top: 8px solid transparent; /* adds visual gap between rows */
  }





</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{% static 'js/state.js' %}"></script>





 <script>
  function openDetails(itemId) {
    fetch(`/dc/item/${itemId}/`)
    .then(response => response.json())
    .then(data => {
    document.getElementById("detailsContent").innerHTML = `
        <p><strong>Project Name:</strong> ${data.project_name}</p>
        <p><strong>Item Name:</strong> ${data.item_name}</p>
        <p><strong>Quantity:</strong> ${data.quantity} </p>
        <p><strong>UOM:</strong> ${data.uom}</p>
        <p><strong>Weight/Unit:</strong> ${data.weight_per_unit}</p>
        <p><strong>Weight:</strong> ${data.weight}</p>
        <p><strong>SquareFeet/Unit:</strong> ${data.square_feet_per_unit}</p>
        <p><strong>SquareFeet:</strong> ${data.square_feet}</p>
        <p><strong>Incharge:</strong> ${data.project_incharge}</p>
        <p><strong>Description:</strong> ${data.description}</p>
        <p><strong>Remarks:</strong> ${data.remarks}</p>
    `;
    document.getElementById("detailsModal").classList.remove("hidden");
});
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded');

    // Debug Update button
    const updateButton = document.getElementById('updateButton');
    if (updateButton) {
        updateButton.addEventListener('click', () => {
            console.log('Update button clicked');
            const modal = new bootstrap.Modal(document.getElementById('updateModal'));
            modal.show();
        });
    } else {
        console.error('Update button not found');
    }

    // Initialize state and city dropdowns
    fetchStates();

    // Party name autocomplete
    $('#partyName').autocomplete({
        source: function(request, response) {
            console.log('Fetching suppliers for term:', request.term);
            $.ajax({
                url: '/api/suppliers/',
                data: { term: request.term },
                dataType: 'json',
                success: function(data) {
                    console.log('Suppliers fetched:', data);
                    response(data.map(item => ({
                        label: item.party_name,
                        value: item.party_name,
                        data: item.data
                    })));
                },
                error: function(xhr) {
                    console.error('Failed to fetch suppliers:', xhr.responseJSON?.message || 'Unknown error');
                }
            });
        },
        minLength: 2,
        select: function(event, ui) {
            console.log('Selected supplier:', ui.item);
            const data = ui.item.data;
            $('#partyAddress1').val(data.address1 || '');
            $('#partyAddress2').val(data.address2 || '');
            $('#partyPincode').val(data.pincode || '');
            $('#partyGstin').val(data.gstin || '');
            $('#partyStateCode').val(data.state_code || '');
            $('#partyState').val(data.state || '');
            fetchModalCities(data.state || '');
        }
    });

    const updateModal = document.getElementById('updateModal');
    if (updateModal) {
        updateModal.addEventListener('shown.bs.modal', () => {
            console.log('Modal shown, initializing validation and state/city fetching');
            validateReceivedQuantities();
            fetchModalStates();
            updateReceivedQuantities(); // Auto-update received quantities and original quantities
        });

        updateModal.addEventListener('hidden.bs.modal', () => {
            console.log('Modal hidden');
            const activeElement = document.activeElement;
            if (updateModal.contains(activeElement)) {
                activeElement.blur();
            }
        });

        // Add event listeners for buttons
        const closeDcBtn = document.getElementById('closeDcBtn');
        const partialDcBtn = document.getElementById('partialDcBtn');

        if (closeDcBtn) {
            closeDcBtn.addEventListener('click', () => {
                console.log('Close DC button clicked');
                if (!validateUpdateForm()) {
                    console.log('Validation failed');
                    return;
                }
                const updateData = getUpdateFormData();
                if (updateData) {
                    updateData.status = 'closed';
                    console.log('Submitting close DC:', updateData);
                    submitUpdateForm(updateData);
                } else {
                    console.error('No update data');
                }
            });
        } else {
            console.error('Close DC button not found');
        }

        if (partialDcBtn) {
            partialDcBtn.addEventListener('click', () => {
                console.log('Partial DC button clicked');
                if (!validateUpdateForm()) {
                    console.log('Validation failed');
                    return;
                }
                const updateData = getUpdateFormData();
                if (updateData) {
                    updateData.status = 'partial';
                    console.log('Submitting partial DC:', updateData);
                    submitUpdateForm(updateData);
                } else {
                    console.error('No update data');
                }
            });
        } else {
            console.error('Partial DC button not found');
        }
    } else {
        console.error('Update modal not found');
    }
});

  function closeDetails() {
    document.getElementById("detailsModal").classList.add("hidden");
}

  function openAllItemsModal() {
  document.getElementById("allItemsModal").classList.remove("hidden");
}
    function closeAllItemsModal() {
    document.getElementById("allItemsModal").classList.add("hidden");
}

function goBack() {
    if (document.referrer && document.referrer.includes('/draft-list')) {
        // Go back to the previous page in history (preserves pagination)
        history.back();
    } else {
        // Fallback to default list page
        window.location.href = '/draft-list/';
    }
}



 // Populate states and cities for main form
    function populateMainFormStates() {
        const stateSelect = $("#buyerState");
        const citySelect = $("#buyerCity");
        const stateCodeInput = $("#buyerStateCode");

        stateSelect.empty().append('<option value="">Select State</option>');
        statesData.forEach(state => {
            stateSelect.append(`<option value="${state.name}" data-gstCode="${state.gstCode}">${state.name}</option>`);
        });

        stateSelect.on('change', function() {
            const stateName = $(this).val();
            citySelect.empty().append('<option value="">Select City</option>');
            stateCodeInput.val('');
            if (stateName) {
                const stateData = statesData.find(s => s.name === stateName);
                if (stateData) {
                    stateCodeInput.val(stateData.gstCode);
                    stateData.districts.forEach(city => {
                        citySelect.append(`<option value="${city}">${city}</option>`);
                    });
                }
            }
        });
    }
    
// Initialize autocomplete for supplier
function initializeSupplierAutocomplete() {
    console.log('Initializing supplier autocomplete for #buyerName');
    $("#buyerName").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "/autocomplete/supplier/",
                dataType: "json",
                data: { term: request.term },
                success: function(data) {
                    console.log('Supplier autocomplete data:', data);
                    response(data);
                },
                error: function(xhr, status, error) {
                    console.error('Supplier autocomplete error:', status, error);
                    console.error('Response:', xhr.responseText);
                    response([]);
                }
            });
        },
        minLength: 1,
        select: function(event, ui) {
            console.log('Supplier selected:', ui.item.data);
            const supplier = ui.item.data;
            $("#buyerAddress1").val(supplier.address1 || '');
            $("#buyerAddress2").val(supplier.address2 || '');
            $("#buyerState").val(supplier.state || '');
            $("#buyerCity").empty().append('<option value="">Select City</option>');
            const stateData = statesData.find(s => s.name === supplier.state);
            if (stateData) {
                stateData.districts.forEach(city => {
                    $("#buyerCity").append(`<option value="${city}" ${city === supplier.city ? 'selected' : ''}>${city}</option>`);
                });
                $("#buyerStateCode").val(stateData.gstCode || '');
            }
            $("#buyerPincode").val(supplier.pincode || '');
            $("#buyerGstin").val(supplier.gstin || '');
            $("#buyerStateCode").val(supplier.state_code || '');
            $("#saveSupplierBtn").show();
        },
        open: function() {
            console.log('Supplier autocomplete dropdown opened');
        }
    }).on('focus', function() {
        if ($(this).val().length > 0) {
            $(this).autocomplete('search', $(this).val());
        }
    });
}
  // Save new supplier
    function saveNewSupplier() {
        const newSupplier = {
            name: $("#buyerName").val().trim(),
            address1: $("#buyerAddress1").val().trim(),
            address2: $("#buyerAddress2").val().trim(),
            state: $("#buyerState").val(),
            city: $("#buyerCity").val(),
            pincode: $("#buyerPincode").val().trim(),
            gstin: $("#buyerGstin").val().trim(),
            state_code: $("#buyerStateCode").val().trim()
        };

        console.log('Supplier data to be sent:', newSupplier);

        if (!newSupplier.name || !newSupplier.address1 || !newSupplier.state || !newSupplier.city || !newSupplier.pincode || !newSupplier.state_code) {
            console.log('Validation failed: Missing required fields');
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Please fill all required fields."
            });
            return;
        }

        if (!/^\d{6}$/.test(newSupplier.pincode)) {
            console.log('Validation failed: Invalid pincode format');
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Invalid pincode format. Must be 6 digits."
            });
            return;
        }

        if (newSupplier.gstin && !/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/.test(newSupplier.gstin)) {
            console.log('Validation failed: Invalid GSTIN format');
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Invalid GSTIN format."
            });
            return;
        }

        console.log('Client-side validation passed, sending AJAX request...');

        $.ajax({
            url: "{% url 'add_supplier' %}",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(newSupplier),
            headers: {
                "X-CSRFToken": $("[name=csrfmiddlewaretoken]").val() || "{{ csrf_token }}"
            },
            beforeSend: function(xhr, settings) {
                console.log('AJAX request details:');
                console.log('URL:', settings.url);
                console.log('Method:', settings.type);
                console.log('Data:', settings.data);
            },
            success: function(response) {
                console.log('AJAX success response:', response);
                if (response.status === 'success') {
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        html: `${response.message}<br><small>Created by: ${response.created_by}<br>Date: ${response.created_date}</small>`
                    });
                    $("#saveSupplierBtn").hide();
                } else {
                    console.log('Server returned error:', response.message);
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: response.message
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error details:');
                console.error('Status:', status);
                console.error('Error:', error);
                console.error('Response Text:', xhr.responseText);
                console.error('Status Code:', xhr.status);

                let errorMessage = "Failed to add supplier. Please try again.";
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse.message) {
                        errorMessage = errorResponse.message;
                    }
                } catch (e) {
                    console.error('Could not parse error response:', e);
                }

                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: errorMessage
                });
            }
        });
    }


let currentSupplier = null; 
function updateSupplier() {

    if (!currentSupplier || !currentSupplier.id) {
        console.error("No supplier selected to update!");
        Swal.fire({ icon: "error", title: "Error", text: "No supplier selected to update." });
        return;
    }
    const updatedSupplier = {
        supplier_id: currentSupplier.id,  // make sure your check_supplier view returns `id`
        name: $("#buyerName").val().trim(),   // keep name for identifying supplier
        address1: $("#buyerAddress1").val().trim(),
        address2: $("#buyerAddress2").val().trim(),
        state: $("#buyerState").val(),
        city: $("#buyerCity").val(),
        pincode: $("#buyerPincode").val().trim(),
        gstin: $("#buyerGstin").val().trim(),
        state_code: $("#buyerStateCode").val().trim()
    };

    console.log("Updating supplier:", updatedSupplier);

    $.ajax({
        url: "{% url 'update_supplier' %}",  // new Django view for update
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(updatedSupplier),
        headers: { "X-CSRFToken": $("[name=csrfmiddlewaretoken]").val() || "{{ csrf_token }}" },
        success: function(response) {
            if (response.status === 'success') {
                Swal.fire({ icon: "success", title: "Supplier Updated", text: response.message });
                $("#updateSupplierBtn").hide();
            } else {
                Swal.fire({ icon: "error", title: "Error", text: response.message });
            }
        },
        error: function(xhr) {
             console.error("Update error:", xhr.responseText);
            Swal.fire({
                icon: "error",
                title: "Update Failed",
                text: "Could not update supplier."
            });
        }
    });
}

$(document).ready(function () {
    const $buyerName = $("#buyerName");
    const $saveBtn = $("#saveSupplierBtn");
    const $updateBtn = $("#updateSupplierBtn");

    let debounceTimer = null;
    let currentSupplier = null;
    let lastCheckedName = "";

    $saveBtn.hide();
    $updateBtn.hide();

    function checkForChanges() {
        const typedName = $buyerName.val().trim();

        if (!typedName) {
            // Nothing typed â†’ no buttons
            $saveBtn.hide();
            $updateBtn.hide();
            return;
        }

        if (currentSupplier && typedName === currentSupplier.name) {
            // Editing existing supplier
            let isEdited = false;

            if ($("#buyerAddress1").val().trim() !== (currentSupplier.address1 || "")) isEdited = true;
            if ($("#buyerAddress2").val().trim() !== (currentSupplier.address2 || "")) isEdited = true;
            if ($("#buyerState").val() !== (currentSupplier.state || "")) isEdited = true;
            if ($("#buyerCity").val() !== (currentSupplier.city || "")) isEdited = true;
            if ($("#buyerPincode").val().trim() !== (currentSupplier.pincode || "")) isEdited = true;
            if ($("#buyerGstin").val().trim() !== (currentSupplier.gstin || "")) isEdited = true;
            if ($("#buyerStateCode").val().trim() !== (currentSupplier.state_code || "")) isEdited = true;

            if (isEdited) {
                $updateBtn.show();
                $saveBtn.hide();
            } else {
                $updateBtn.hide();
                $saveBtn.hide();
            }
        } else {
            // Name changed â†’ treat as new supplier
            $saveBtn.show();
            $updateBtn.hide();
        }
    }

    function checkSupplier(name) {
        if (!name) {
            currentSupplier = null;
           
        // Clear only supplier section
        $("#buyerAddress1").val("");
        $("#buyerAddress2").val("");
        $("#buyerState").val("");
        $("#buyerCity").val("");
        $("#buyerPincode").val("");
        $("#buyerGstin").val("");
        $("#buyerStateCode").val("");
            checkForChanges();
            return;
        }

        $.ajax({
            url: "{% url 'check_supplier' %}",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ name: name }),
            headers: { "X-CSRFToken": $("[name=csrfmiddlewaretoken]").val() || "{{ csrf_token }}" },
            success: function(response) {
                if (response.exists && response.supplier) {
                    currentSupplier = response.supplier;
                    lastCheckedName = response.supplier.name;

                    // Fill form fields
                    $("#buyerAddress1").val(response.supplier.address1 || "");
                    $("#buyerAddress2").val(response.supplier.address2 || "");
                    $("#buyerState").val(response.supplier.state || "");
                    $("#buyerCity").val(response.supplier.city || "");
                    $("#buyerPincode").val(response.supplier.pincode || "");
                    $("#buyerGstin").val(response.supplier.gstin || "");
                    $("#buyerStateCode").val(response.supplier.state_code || "");
                } else {
                    currentSupplier = null;
                  
        // Clear only supplier section
        $("#buyerAddress1").val("");
        $("#buyerAddress2").val("");
        $("#buyerState").val("");
        $("#buyerCity").val("");
        $("#buyerPincode").val("");
        $("#buyerGstin").val("");
        $("#buyerStateCode").val("");
                }
                checkForChanges();
            },
            error: function(xhr, status, error) {
                console.error("Supplier check AJAX error:", status, error);
            }
        });
    }

    // ðŸ”¹ Debounced typing lookup
    $buyerName.on("input", function () {
        clearTimeout(debounceTimer);
        const typedName = $(this).val().trim();
        debounceTimer = setTimeout(() => checkSupplier(typedName), 300);
    });

    // ðŸ”¹ On manual select (e.g. datalist)
    $buyerName.on("change", function () {
        checkSupplier($(this).val().trim());
    });

    // ðŸ”¹ Track other field changes
    $(".form-control").on("input change", function () {
        checkForChanges();
    });

    // ðŸ”¹ Button actions
    $saveBtn.on("click", function () { saveNewSupplier(); });
    $updateBtn.on("click", function () { updateSupplier(); });
});




    // Fallback for jQuery and jQuery UI
    if (typeof jQuery === 'undefined') {
        console.error('jQuery not loaded, attempting to load local fallback');
        document.write('<script src="{% static "js/jquery-3.6.0.min.js" %}"><\/script>');
    }
    if (typeof jQuery.ui === 'undefined') {
        console.error('jQuery UI not loaded, attempting to load local fallback');
        document.write('<script src="{% static "js/jquery-ui.min.js" %}"><\/script>');
    }

    function toggleColumns() {
      const showWeight = $("#showWeight").is(":checked");
      const showSquareFeet = $("#showSquareFeet").is(":checked");

      // Weight column inputs
      $(".weight-column input").prop("disabled", !showWeight)
                              .toggleClass("bg-gray-200 text-gray-500", !showWeight) // disabled style
                              .toggleClass("bg-white text-black", showWeight);       // enabled style

      // Square Feet column inputs
      $(".square-feet-column input").prop("disabled", !showSquareFeet)
                                    .toggleClass("bg-gray-200 text-gray-500", !showSquareFeet)
                                    .toggleClass("bg-white text-black", showSquareFeet);

      // Save state
      localStorage.setItem("dcform_showWeight", showWeight);
      localStorage.setItem("dcform_showSquareFeet", showSquareFeet);
  }

// Calculate total weight
function calculateTotalWeight($block) {
    const quantity = parseFloat($block.find('.quantity').val()) || 0;
    const weightPerUnit = parseFloat($block.find('.weight-per-unit').val()) || 0;
    const totalWeight = (quantity * weightPerUnit).toFixed(2);

    $block.find('.total-weight').val(totalWeight);
    $block.find('input[name="weight[]"]').val(totalWeight);
}

// Calculate total square feet
function calculateTotalSquareFeet($block) {
    const quantity = parseFloat($block.find('.quantity').val()) || 0;
    const squareFeetPerUnit = parseFloat($block.find('.square-feet-per-unit').val()) || 0;
    const totalSquareFeet = (quantity * squareFeetPerUnit).toFixed(2);

    $block.find('.total-square-feet').val(totalSquareFeet);
    $block.find('input[name="square_feet[]"]').val(totalSquareFeet);
}

// Recalculate when quantity or weight_per_unit changes
$(document).on('input', '.quantity, .weight-per-unit', function() {
    const $row = $(this).closest('tbody.item-block');
    calculateTotalWeight($row);
});

// Recalculate when quantity or square_feet_per_unit changes
$(document).on('input', '.quantity, .square-feet-per-unit', function() {
    const $row = $(this).closest('tbody.item-block');
    calculateTotalSquareFeet($row);
});


    // Populate states and cities for main form
    function populateMainFormStates() {
        const stateSelect = $("#buyerState");
        const citySelect = $("#buyerCity");
        const stateCodeInput = $("#buyerStateCode");

        stateSelect.empty().append('<option value="">Select State</option>');
        statesData.forEach(state => {
            stateSelect.append(`<option value="${state.name}" data-gstCode="${state.gstCode}">${state.name}</option>`);
        });

        stateSelect.on('change', function() {
            const stateName = $(this).val();
            citySelect.empty().append('<option value="">Select City</option>');
            stateCodeInput.val('');
            if (stateName) {
                const stateData = statesData.find(s => s.name === stateName);
                if (stateData) {
                    stateCodeInput.val(stateData.gstCode);
                    stateData.districts.forEach(city => {
                        citySelect.append(`<option value="${city}">${city}</option>`);
                    });
                }
            }
        });
    }

       function initializeItemAutocomplete(selector) {
    console.log('Initializing item autocomplete for:', selector);
    $(selector).each(function() {
        $(this).autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "/autocomplete/item/",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log('Item autocomplete data:', data);
                        response(data);
                    },
                    error: function(xhr, status, error) {
                        console.error('Item autocomplete error:', status, error);
                        console.error('Response:', xhr.responseText);
                        response([]);
                    }
                });
            },
            minLength: 1,
            select: function(event, ui) {
                console.log('Item selected:', ui.item.data);
                const item = ui.item.data;

                // Get the block
                const block = $(this).closest(".item-block");
                // const rows = block.find("tr");

                // Row 2 â†’ Item details
                $block.find('input[name="item_name[]"]').val(item.item_name || '');
                // rows.eq(1).find('input[name="description[]"]').val(item.description || '');
                // rows.eq(1).find('input[name="project_name[]"]').val(item.project_name || '');
                // rows.eq(1).find('input[name="project_incharge[]"]').val(item.project_incharge || '');

                // // Row 4 â†’ Quantity, UOM, weight, sqft, rate
                // rows.eq(3).find('input[name="quantity[]"]').val(item.quantity || 0);
                // rows.eq(3).find('select[name="uom[]"]').val(item.uom || '');
                // rows.eq(3).find('input[name="weight_per_unit[]"]').val(item.weight_per_unit || 0);
                // rows.eq(3).find('input[name="total_weight[]"]').val(item.weight || 0);
                // rows.eq(3).find('input[name="square_feet_per_unit[]"]').val(item.square_feet_per_unit || 0);
                // rows.eq(3).find('input[name="total_square_feet[]"]').val(item.square_feet || 0);
                // rows.eq(3).find('input[name="rate[]"]').val(item.rate_per_each || 0);

                // // Row 6 â†’ Remarks
                // rows.eq(5).find('input[name="remarks[]"]').val(item.remarks || '');

                // Recalculate totals
                // calculateTotalWeight(block);
                // calculateTotalSquareFeet(block);
                calculateTotalWeight($block);
                calculateTotalSquareFeet($block);
            },
            open: function() {
                console.log('Item autocomplete dropdown opened');
            }
        }).on('focus', function() {
            if ($(this).val().length > 0) {
                $(this).autocomplete('search', $(this).val());
            }
        });
    });
}

// Save draft changes
function saveDraftChanges(draftId) {
    const formData = $('#editForm').serializeArray();
    const requiredFields = ['buyerName', 'buyerAddress1', 'buyerCity', 'buyerState', 'buyerStateCode', 'buyerPincode', 'dcDate', 'process'];
    for (const field of requiredFields) {
        if (!formData.find(item => item.name === field)?.value) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field`
            });
            return;
        }
    }

    const data = {
        draft_id: draftId,
        dcNo: formData.find(item => item.name === 'dcNo')?.value || '',
        dcType: formData.find(item => item.name === 'dcType')?.value || '',
        dcDate: formData.find(item => item.name === 'dcDate')?.value || '',
        buyerName: formData.find(item => item.name === 'buyerName')?.value || '',
        buyerAddress1: formData.find(item => item.name === 'buyerAddress1')?.value || '',
        buyerAddress2: formData.find(item => item.name === 'buyerAddress2')?.value || '',
        buyerCity: formData.find(item => item.name === 'buyerCity')?.value || '',
        buyerState: formData.find(item => item.name === 'buyerState')?.value || '',
        buyerStateCode: formData.find(item => item.name === 'buyerStateCode')?.value || '',
        buyerPincode: formData.find(item => item.name === 'buyerPincode')?.value || '',
        buyerGstin: formData.find(item => item.name === 'buyerGstin')?.value || '',
        vehicleNo: formData.find(item => item.name === 'vehicleNo')?.value || '',
        process: formData.find(item => item.name === 'process')?.value || '',
        notes: formData.find(item => item.name === 'notes')?.value || '',
        showWeight: $("#showWeight").is(":checked"),
        showSquareFeet: $("#showSquareFeet").is(":checked"),
        items: []
    };

    let hasValidItem = false;
    data.items = [];
    $('#itemsTableBody .item-block').each(function() {
        const item = {
            item_name: $(this).find('input[name="item_name[]"]').val().trim() || '',
            description: $(this).find('input[name="description[]"]').val().trim() || '',
            uom: $(this).find('select[name="uom[]"]').val() || '',
            quantity: parseFloat($(this).find('input[name="quantity[]"]').val()) || 0,
            weight_per_unit: parseFloat($(this).find('input[name="weight_per_unit[]"]').val()) || 0,
            weight: parseFloat($(this).find('input[name="weight[]"]').val()) || 0,
            square_feet_per_unit: parseFloat($(this).find('input[name="square_feet_per_unit[]"]').val()) || 0,
            square_feet: parseFloat($(this).find('input[name="square_feet[]"]').val()) || 0,
            rate_per_each: parseFloat($(this).find('input[name="rate_per_each[]"]').val()) || 0,
            project_name: $(this).find('input[name="project_name[]"]').val() || '',
            project_incharge: $(this).find('input[name="project_incharge[]"]').val() || '',
            remarks: $(this).find('input[name="remarks[]"]').val() || ''
        };
        if (item.item_name || item.description) {
            data.items.push(item);
            hasValidItem = true;
        }
    });

    if (!hasValidItem) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'At least one item with a name or description is required'
        });
        return;
    }

    $.ajax({
        url: '/update-draft/',
        method: 'POST',
        contentType: 'application/json',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Draft updated successfully!',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    $('#editModal').modal('hide');
                    window.location.href = '/draft-list/';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.message || 'Failed to update draft'
                });
            }
        },
        error: function(xhr) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: xhr.responseJSON?.message || 'Failed to update draft'
            });
        }
    });
}

// Save delivery note with DC number generation
function saveDeliveryNote(draftId) {
    const data = {
        draft_id: draftId,
        dcNumber: "{{ dc.dcNo|escapejs }}",
        dcType: "{{ dc.dcType|escapejs }}",
        dcDate: "{{ dc.dcDate|date:'Y-m-d'|escapejs }}",
        buyerName: "{{ dc.buyerName|escapejs }}",
        buyerAddress1: "{{ dc.buyerAddress1|escapejs }}",
        buyerAddress2: "{{ dc.buyerAddress2|escapejs }}",
        buyerCity: "{{ dc.buyerCity|escapejs }}",
        buyerState: "{{ dc.buyerState|escapejs }}",
        buyerStateCode: "{{ dc.buyerStateCode|escapejs }}",
        buyerPincode: "{{ dc.buyerPincode|escapejs }}",
        buyerGstin: "{{ dc.buyerGstin|escapejs }}",
        vehicleNo: "{{ dc.vehicleNo|escapejs }}",
        process: "{{ dc.process|escapejs }}",
        notes: "{{ dc.notes|escapejs }}",
        showWeight: $("#showWeight").is(":checked"),
        showSquareFeet: $("#showSquareFeet").is(":checked"),
        items: [
            {% for item in items %}
            {
                item_name: "{{ item.item_name|escapejs }}",
                description: "{{ item.description|escapejs }}",
                uom: "{{ item.uom|escapejs }}",
                quantity: "{{ item.quantity|escapejs }}",
                weight_per_unit: "{{ item.weight_per_unit|escapejs }}",
                weight: "{{ item.weight|escapejs }}",
                square_feet_per_unit: "{{ item.square_feet_per_unit|escapejs }}",
                square_feet: "{{ item.square_feet|escapejs }}",
                rate_per_each: "{{ item.rate_per_each|escapejs }}",
                project_name: "{{ item.project_name|escapejs }}",
                project_incharge: "{{ item.project_incharge|escapejs }}",
                remarks: "{{ item.remarks|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };

    Swal.fire({
        title: 'Confirm Save',
        text: 'Are you sure you want to finalize this delivery note?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Save',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            if (!data.dcNumber) {
                const dcType = data.dcType;
                if (!dcType) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'DC Type is missing'
                    });
                    return;
                }

                $.ajax({
                    url: '/get-next-dc-number/',
                    method: 'GET',
                    data: { dc_type: dcType },
                    success: function(response) {
                        if (response.dc_number) {
                            data.dcNumber = response.dc_number;
                            $('#editForm input[name="dcNo"]').val(response.dc_number);
                            saveDeliveryNoteToDB(draftId, data);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message || 'Failed to generate DC number'
                            });
                        }
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: xhr.responseJSON?.message || 'Failed to generate DC number'
                        });
                    }
                });
            } else {
                saveDeliveryNoteToDB(draftId, data);
            }
        }
    });
}

// Function to save delivery note to database
function saveDeliveryNoteToDB(draftId, data) {
    $.ajax({
        url: '/save-delivery-note/',
        method: 'POST',
        contentType: 'application/json',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Saved',
                    text: 'Delivery note saved successfully!',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = '/dashboard/';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.message
                });
            }
        },
        error: function(xhr) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: xhr.responseJSON?.message || 'Failed to save delivery note'
            });
        }
    });
}

function dcDelete(draftId) {
    Swal.fire({
        title: "Are you sure?",
        text: "This will permanently delete the draft and its items!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it!"
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "/delete-draft/" + draftId + "/",
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") },
                success: function(response) {
                    if (response.success) {
                        Swal.fire("Deleted!", response.message, "success").then(() => {
                            window.location.href = "/draft-list/";
                        });
                    } else {
                        Swal.fire("Error", response.message, "error");
                    }
                },
                error: function(xhr) {
                    Swal.fire("Error", xhr.responseJSON?.message || "Failed to delete draft", "error");
                }
            });
        }
    });
}



    $(document).ready(function() {
    // Initialize column visibility
    toggleColumns();
    $("#showWeight, #showSquareFeet").on("change", toggleColumns);

    // Populate states and cities
    populateMainFormStates();

    // Initialize supplier autocomplete
    initializeSupplierAutocomplete();

    // When modal opens
    $("#editModal").on("show.bs.modal", function (event) {
        const button = $(event.relatedTarget);
        const draftId = button.data("draft-id");

        $.ajax({
            url: "/get-draft/" + draftId + "/",
            method: "GET",
            success: function (response) {
                if (response.success) {
                    const data = response.data;

                    /** ------------ Main Form -------------- **/
                    $("#editForm select[name='dcType']").val(data.dcType || "");
                    $("#editForm input[name='dcDate']").val(data.dcDate || "");
                    $("#editForm input[name='buyerName']").val(data.buyerName || "");
                    $("#editForm input[name='buyerAddress1']").val(data.buyerAddress1 || "");
                    $("#editForm input[name='buyerAddress2']").val(data.buyerAddress2 || "");
                    $("#editForm select[name='buyerState']").val(data.buyerState || "").trigger("change");

                    setTimeout(() => {
                        $("#editForm select[name='buyerCity']").val(data.buyerCity || "");
                    }, 100);

                    $("#editForm input[name='buyerPincode']").val(data.buyerPincode || "");
                    $("#editForm input[name='buyerGstin']").val(data.buyerGstin || "");
                    $("#editForm input[name='buyerStateCode']").val(data.buyerStateCode || "");
                    $("#editForm input[name='vehicleNo']").val(data.vehicleNo || "");
                    $("#editForm input[name='process']").val(data.process || "");
                    $("#editForm textarea[name='notes']").val(data.notes || "");
                    $("#showWeight").prop("checked", data.showWeight || false);
                    $("#showSquareFeet").prop("checked", data.showSquareFeet || false);

                    toggleColumns();

                    /** ------------ Items Section -------------- **/
                    const $itemsBody = $('#itemsTableBody');
                    $itemsBody.empty();

                    (data.items || []).forEach((item, index) => {
                        const block = `
                            <tbody class="item-block">
                                <!-- Row 1 -->
                                <tr>
                                    <th style="width:5%;">S.No</th>
                                    <th colspan="2">Item Name</th>
                                    <th colspan="2">Description</th>
                                    <th colspan="2">Project Name</th>
                                    <th colspan="2">Project Incharge</th>
                                </tr>
                                <tr>
                                    <td rowspan="5">${index + 1}</td>
                                    <td colspan="2"><input type="text" class="form-control item-name item-name-autocomplete" name="item_name[]" value="${item.item_name || ''}"></td>
                                    <td colspan="2"><input type="text" class="form-control" name="description[]" value="${item.description || ''}"></td>
                                    <td colspan="2"><input type="text" class="form-control" name="project_name[]" value="${item.project_name || ''}"></td>
                                    <td colspan="2"><input type="text" class="form-control" name="project_incharge[]" value="${item.project_incharge || ''}"></td>
                                </tr>

                                <!-- Row 2 -->
                                <tr>
                                    <th>Quantity</th>
                                    <th>UOM</th>
                                    <th class="weight-column">Weight/Unit</th>
                                    <th class="weight-column">Total Wt</th>
                                    <th class="square-feet-column">SqFt/Unit</th>
                                    <th class="square-feet-column">Total SqFt</th>
                                    <th>Rate</th>
                                </tr>
                                <tr>
                                    <td><input type="number" class="form-control quantity" name="quantity[]" value="${item.quantity || ''}" step="0.01"></td>
                                    <td>
                                        <select class="form-control" name="uom[]">
                                            <option value="">UOM</option>
                                            <option value="NOS" ${item.uom === 'NOS' ? 'selected' : ''}>NOS</option>
                                            <option value="KG" ${item.uom === 'KG' ? 'selected' : ''}>KG</option>
                                            <option value="METER" ${item.uom === 'METER' ? 'selected' : ''}>METER</option>
                                            <option value="LITER" ${item.uom === 'LITER' ? 'selected' : ''}>LITER</option>
                                            <option value="SET" ${item.uom === 'SET' ? 'selected' : ''}>SET</option>
                                            <option value="PIECE" ${item.uom === 'PIECE' ? 'selected' : ''}>PIECE</option>
                                        </select>
                                    </td>
                                    <td class="weight-column"><input type="number" class="form-control weight-per-unit" name="weight_per_unit[]" value="${item.weight_per_unit || 0}" step="0.01"></td>
                                    <td class="weight-column"><input type="number" class="form-control total-weight" name="weight[]" value="${item.weight || 0}" step="0.01" readonly></td>
                                    <td class="square-feet-column"><input type="number" class="form-control square-feet-per-unit" name="square_feet_per_unit[]" value="${item.square_feet_per_unit || 0}" step="0.01"></td>
                                    <td class="square-feet-column"><input type="number" class="form-control total-square-feet" name="square_feet[]" value="${item.square_feet || 0}" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control" name="rate[]" value="${item.rate_per_each || 0}" step="0.01"></td>
                                </tr>

                                <!-- Row 3 -->
                                <tr>
                                    <th colspan="4">Remarks</th>
                                    <th colspan="4">Action</th>
                                </tr>
                                <tr>
                                    <td colspan="4"><input type="text" class="form-control" name="remarks[]" value="${item.remarks || ''}"></td>
                                    <td colspan="4"><button type="button" class="btn btn-danger btn-sm remove-item-btn">Delete</button></td>
                                </tr>
                            </tbody>`;

                        $itemsBody.append(block);
                         

                        // recalc after adding
                        calculateTotalWeight($itemsBody.find("tbody").last());
                        calculateTotalSquareFeet($itemsBody.find("tbody").last());
                    });

                    /** ------------ Autocomplete for items -------------- **/
                    $(".item-name-autocomplete").autocomplete({
                        source: function (request, response) {
                            $.ajax({
                                url: "/autocomplete/item/",
                                data: { term: request.term },
                                dataType: "json",
                                success: function (data) {
                                    response(data.map(item => ({
                                        label: item.item_name,
                                        value: item.item_name,
                                        description: item.description,
                                        uom: item.uom,
                                        rate: item.rate_per_each,
                                        weight_per_unit: item.weight_per_unit,
                                        square_feet_per_unit: item.square_feet_per_unit
                                    })));
                                }
                            });
                        },
                        minLength: 2,
                        select: function (event, ui) {
                            const $block = $(this).closest("tbody.item-block");
                            $block.find('input[name="description[]"]').val(ui.item.description || "");
                            $block.find('select[name="uom[]"]').val(ui.item.uom || "");
                            $block.find('input[name="rate[]"]').val(ui.item.rate ? parseFloat(ui.item.rate).toFixed(2) : "");
                            $block.find('input[name="weight_per_unit[]"]').val(ui.item.weight_per_unit ? parseFloat(ui.item.weight_per_unit).toFixed(2) : "");
                            $block.find('input[name="square_feet_per_unit[]"]').val(ui.item.square_feet_per_unit ? parseFloat(ui.item.square_feet_per_unit).toFixed(2) : "");

                            // $itemsBody.append(block);

                            // const $newBlock = $itemsBody.find("tbody.item-block").last();
                            calculateTotalWeight($newBlock);
                            calculateTotalSquareFeet($newBlock);

                        }
                    });
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: response.message || "Failed to load draft data"
                    });
                }
            },
            error: function (xhr) {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: xhr.responseJSON?.message || "Failed to load draft data"
                });
            }
        });
    });

    // Add new item row
    $(document).on("click", ".add-item", function () {
      // const $itemsBody = $('#itemsTableBody');
        const rowCount = $('#itemsTableBody tbody.item-block').length + 1;

        const block = ` <tbody class="item-block">
                                <!-- Row 1 -->
                                <tr>
                                    <th style="width:5%;">S.No</th>
                                    <th colspan="2">Item Name</th>
                                    <th colspan="2">Description</th>
                                    <th colspan="2">Project Name</th>
                                    <th colspan="2">Project Incharge</th>
                                </tr>
                                <tr>
                                    <td rowspan="5">${rowCount}</td>
                                    <td colspan="2"><input type="text" class="form-control item-name item-name-autocomplete" name="item_name[]" value=""></td>
                                    <td colspan="2"><input type="text" class="form-control" name="description[]" value=""></td>
                                    <td colspan="2"><input type="text" class="form-control" name="project_name[]" value=""></td>
                                    <td colspan="2"><input type="text" class="form-control" name="project_incharge[]" value=""></td>
                                </tr>

                                <!-- Row 2 -->
                                <tr>
                                    <th>Quantity</th>
                                    <th>UOM</th>
                                    <th class="weight-column">Weight/Unit</th>
                                    <th class="weight-column">Total Wt</th>
                                    <th class="square-feet-column">SqFt/Unit</th>
                                    <th class="square-feet-column">Total SqFt</th>
                                    <th>Rate</th>
                                </tr>
                                <tr>
                                    <td><input type="number" class="form-control quantity" name="quantity[]" value="" step="0.01"></td>
                                    <td>
                                        <select class="form-control" name="uom[]">
                                            <option value="">UOM</option>
                                            <option value="NOS">NOS</option>
                                            <option value="KG">KG</option>
                                            <option value="METER">METER</option>
                                            <option value="LITER">LITER</option>
                                            <option value="SET">SET</option>
                                            <option value="PIECE">PIECE</option>
                                        </select>
                                    </td>
                                    <td class="weight-column"><input type="number" class="form-control weight-per-unit" name="weight_per_unit[]" value="0" step="0.01"></td>
                                    <td class="weight-column"><input type="number" class="form-control weight" name="weight[]" value="0" step="0.01" readonly></td>
                                    <td class="square-feet-column"><input type="number" class="form-control square-feet-per-unit" name="square_feet_per_unit[]" value="0" step="0.01"></td>
                                    <td class="square-feet-column"><input type="number" class="form-control square-feet" name="square_feet[]" value="0" step="0.01" readonly></td>
                                    <td><input type="number" class="form-control" name="rate[]" value="0" step="0.01"></td>
                                </tr>

                                <!-- Row 3 -->
                                <tr>
                                    <th colspan="4">Remarks</th>
                                    <th colspan="4">Action</th>
                                </tr>
                                <tr>
                                    <td colspan="4"><input type="text" class="form-control" name="remarks[]" value=""></td>
                                    <td colspan="4"><button type="button" class="btn btn-danger btn-sm remove-item-btn">Delete</button></td>
                                </tr>
                            </tbody>`;

                        $('#itemsTableBody').append(block);
                        const $newBlock = $('#itemsTableBody tbody.item-block').last();

                        // recalc for that block
                        calculateTotalWeight($newBlock);
                        calculateTotalSquareFeet($newBlock);

                        });
    /** ------------ Delete Item Block -------------- **/
    $(document).on("click", ".remove-item-btn", function () {
        const $allBlocks = $("#itemsTableBody .item-block");

        if ($allBlocks.length > 1) {
            $(this).closest(".item-block").remove();
        } else {
            Swal.fire({
                icon: "warning",
                title: "At least one item required",
                text: "You cannot remove the last item."
            });
        }
    });

    $('#editModal').on('hidden.bs.modal', function () {
    // Reset the whole form
    $('#editForm')[0].reset();

    // Also clear items table
    $('#itemsTableBody').empty();
});
});



</script>
{% endblock %}